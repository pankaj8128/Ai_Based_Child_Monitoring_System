{% extends "layout.html" %}
{% block title %}Chat - Child Monitoring System{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <div class="card chat-card shadow-sm">

        <!-- Header -->
        <div class="card-header bg-primary text-white d-flex align-items-center">
          <i class="bi bi-chat-dots-fill me-2"></i>
          <span>Chat with {{ chat_partner_name|title }}</span>
        </div>

        <!-- Chat Body -->
        <div class="card-body chat-body" id="chat-body">
          <div class="chat-messages">

            {% if messages %}
            {% for msg in messages %}
            <div class="chat-message {% if msg.sender.id == user.id %}sent{% else %}received{% endif %}">

              <div class="message-meta">
                <span class="sender-name">{{ msg.sender_name }}</span>
                <span class="timestamp local-time" data-timestamp="{{ msg.timestamp|date:'c' }}">
                  {{ msg.timestamp|date:"M d, Y H:i" }}
                </span>
              </div>

              {% if msg.image %}
              <div class="message-image">
                <img src="{{ msg.image.url }}" alt="Image">
              </div>
              {% endif %}

              {% if msg.text %}
              <div class="message-text">
                {{ msg.text }}
              </div>
              {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center text-muted py-5">
              <i class="bi bi-chat-left-text fs-3"></i>
              <p class="mt-2">No messages yet. Start the conversation!</p>
            </div>
            {% endif %}

          </div>
        </div>

        <!-- Footer -->
        <div class="card-footer chat-footer">
          <form method="post" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
            {% csrf_token %}

            <!-- Hidden ID -->
            {% if selected_daycare_id %}
            <input type="hidden" name="daycare_id" value="{{ selected_daycare_id }}">
            {% endif %}

            <input type="text" name="text" class="form-control" placeholder="Type your message..." autocomplete="off">

            <input type="file" name="image" accept="image/*" class="form-control form-control-sm"
              style="max-width: 180px;">

            <button type="submit" class="btn btn-primary">
              <i class="bi bi-send-fill"></i>
            </button>
          </form>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Styles -->
<style>
  .chat-card {
    border-radius: 20px;
    overflow: hidden;
  }

  .chat-body {
    background: #f8f9fa;
    min-height: 400px;
    max-height: 500px;
    overflow-y: auto;
    padding: 1rem;
  }

  .chat-messages {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .chat-message {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 15px;
    position: relative;
    background: #e9ecef;
    align-self: flex-start;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .chat-message.sent {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    align-self: flex-end;
  }

  .chat-message.received {
    background: #e9ecef;
    color: #2d3436;
  }

  .message-meta {
    font-size: 0.75rem;
    opacity: 0.8;
    margin-bottom: 0.3rem;
    display: flex;
    justify-content: space-between;
  }

  .message-image img {
    max-width: 200px;
    border-radius: 10px;
    margin-bottom: 0.5rem;
  }

  .message-text {
    word-break: break-word;
  }

  .chat-footer {
    background: #f1f2f6;
    padding: 0.75rem 1rem;
    border-top: 1px solid #e9ecef;
  }

  /* Mobile */
  @media (max-width: 768px) {
    .chat-card {
      border-radius: 10px;
    }

    .chat-body {
      min-height: 250px;
      max-height: 350px;
    }

    .chat-message {
      max-width: 90%;
    }
  }
</style>

<script>
  const chatBody = document.getElementById("chat-body");
  chatBody.scrollTop = chatBody.scrollHeight;

  document.addEventListener("DOMContentLoaded", function () {
    const timeElements = document.querySelectorAll(".local-time");
    timeElements.forEach((el) => {
      const timestamp = el.getAttribute("data-timestamp");
      if (timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const isToday = date.toDateString() === now.toDateString();

        const options = {
          hour: '2-digit',
          minute: '2-digit',
        };

        if (!isToday) {
          options.month = 'short';
          options.day = 'numeric';
        }

        el.textContent = date.toLocaleString(undefined, options);
      }
    });
  });
</script>

{% endblock %}